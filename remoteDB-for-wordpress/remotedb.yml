##################################################
# Wordpress RemoteDB playbook for CentOS by rk v0.1
##################################################
---
- hosts:                 all
  become:                true
  vars_files:
    - vars/rdbdefault.yml

  tasks:

    - name:              Install mariadb packages
      yum:
        name:            "{{ dbpacks }}"
      vars:
        packages:
         - mariadb-client
         - mariadb-common
         - mariadb-server

    - name:              Start MariaDB
      service:           name=mysql state=started

    - name:              Is root password set?
      command:           mysql -u root --execute "SELECT NOW()"
      register:          is_root_password_set
      ignore_errors:     yes

    - name:              Set root password
      mysql_user:        user=root password="{{ mariadb_root_pw }}" host=localhost
      when:              is_root_password_set.rc == 0

    - name:              Inform user of mysql root password
      debug:
        msg:             "MariaDB root password was set to {{ mariadb_root_pw }}"
      when:              is_root_password_set.rc == 0

    - name:              Create myapp database
      mysql_db:
        name:            {{ db_name }}
        login_user:      root
        login_password:  "{{ mariadb_root_pw }}"
        login_host:      localhost
        state:           present

    - name:              Create databse for wordpress
      mysql_db:
        name:            {{ db_name }}
        login_user:      root
        login_password:  "{{ mariadb_root_pw }}"
        login_host:      localhost
        state:           present
      when:              is_root_password_set.rc == 0

    - name:              Create user for the wordpress remote DB
      mysql_user:
        name:            {{ db_user }}
        password:        "{{ db_user_pw }}"
        priv:            myapp.*:SELECT,INSERT,UPDATE,DELETE
        login_user:      root
        login_password:  "{{ mariadb_root_pw }}"
        state:           present
      when:              is_root_password_set.rc == 0
